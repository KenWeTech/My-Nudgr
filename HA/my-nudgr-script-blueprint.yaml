blueprint:
  name: My Nudgr Notification Script
  description: |
    Processes reminder data from My Nudgr, sending notifications and TTS alerts based on priority to mapped recipients.
  domain: script
  source_url: https://github.com/kenwetech/my-nudgr/blob/main/HA/my-nudgr-script-blueprint.yaml

  input:
    p1_name:
      name: Recipient 1 Name
      description: Enter the exact name that the server will send (e.g., "Jo")
      selector:
        text: null
    p1_devices:
      name: Recipient 1 Notification Targets
      description: Enter one or more notify services, comma-separated (e.g., notify.mobile_app_jo_phone, notify.notify)
      selector:
        text:
          multiline: true

    p2_name:
      name: Recipient 2 Name
      description: Enter the exact name that the server will send (e.g., "Sam")
      selector:
        text: null
    p2_devices:
      name: Recipient 2 Notification Targets
      description: Enter one or more notify services, comma-separated (e.g., notify.mobile_app_sam_phone)
      selector:
        text:
          multiline: true

    p3_name:
      name: Recipient 3 Name
      description: Enter the exact name that the server will send (e.g., "Lex")
      selector:
        text: null
    p3_devices:
      name: Recipient 3 Notification Targets
      description: Enter one or more notify services, comma-separated (e.g., notify.mobile_app_lex_tablet)
      selector:
        text:
          multiline: true

    p4_name:
      name: Recipient 4 Name
      description: Enter the exact name that the server will send (e.g., "Ray")
      selector:
        text: null
    p4_devices:
      name: Recipient 4 Notification Targets
      description: Enter one or more notify services, comma-separated (e.g., notify.mobile_app_ray_iphone)
      selector:
        text:
          multiline: true

    default_devices:
      name: Default Devices
      description: Fallback notify services for unrecognized recipients, comma-separated
      selector:
        text:
          multiline: true

    tts_entity:
      name: TTS Speaker
      description: The media_player entity to use for voice announcements.
      selector:
        entity:
          domain: media_player

mode: parallel

fields:
  priority:
    description: The priority of the reminder (1, 2, or 3).
    selector:
      number:
        min: 1
        max: 3
        step: 1
        mode: slider
    example: 1

  text:
    description: The main text of the reminder.
    selector:
      text:
        multiline: true
    example: Take out the trash

  recipient:
    description: The intended recipient's name (e.g., "Sam", "Ray", "default").
    selector:
      text: null
    default: default
    example: Sam

  id:
    description: The unique ID of the reminder for notification tagging.
    selector:
      text: null

  actions:
    description: A dictionary containing URLs for notification actions.
    example: "{\"nudge\": \"http://...\", \"confirm\": \"http://...\"}"

  due_datetime:
    description: The ISO 8601 formatted due date.
    selector:
      datetime: null
    example: "2025-06-05T21:30:00-04:00"

sequence:
  - variables:
      lower_recipient: "{{ recipient | lower }}"
      map: >-
        {{
          {
            (p1_name | lower): p1_devices.split(','),
            (p2_name | lower): p2_devices.split(','),
            (p3_name | lower): p3_devices.split(','),
            (p4_name | lower): p4_devices.split(',')
          }
        }}
      resolved_devices: "{{ map.get(lower_recipient, default_devices.split(',')) }}"
      nudge_url: "{{ actions.nudge if actions is defined and actions.nudge is not none else none }}"
      confirm_url: "{{ actions.confirm if actions is defined and actions.confirm is not none else none }}"
      notification_actions: |
        {% set acts = [] %}
        {% if nudge_url %}
          {% set acts = acts + [{'action': 'URI', 'title': 'Nudge Me Again Later', 'uri': nudge_url}] %}
        {% endif %}
        {% if confirm_url %}
          {% set acts = acts + [{'action': 'URI', 'title': 'Confirm (Stop Alerts)', 'uri': confirm_url}] %}
        {% endif %}
        {{ acts }}

  - choose:
      - conditions:
          - condition: template
            value_template: "{{ priority == 1 }}"
        sequence:
          - repeat:
              for_each: "{{ resolved_devices }}"
              sequence:
                - service: "{{ repeat.item | trim }}"
                  data:
                    title: "ðŸ”¥ High Priority Reminder"
                    message: "{{ text }}"
                    data:
                      tag: "reminder-{{ id }}"
                      push:
                        sound:
                          name: default
                          critical: 1
                          volume: 1
                      actions: "{{ notification_actions }}"
          - service: tts.google_translate_say
            data:
              entity_id: !input tts_entity
              message: "This is a high priority reminder for {{ recipient }}. {{ text }}"

      - conditions:
          - condition: template
            value_template: "{{ priority == 2 }}"
        sequence:
          - repeat:
              for_each: "{{ resolved_devices }}"
              sequence:
                - service: "{{ repeat.item | trim }}"
                  data:
                    title: "ðŸ”” Reminder"
                    message: "{{ text }}"
                    data:
                      tag: "reminder-{{ id }}"
                      actions: "{{ notification_actions }}"
          - service: tts.google_translate_say
            data:
              entity_id: !input tts_entity
              message: "Here is a reminder. {{ text }}"

      - conditions:
          - condition: template
            value_template: "{{ priority == 3 }}"
        sequence:
          - repeat:
              for_each: "{{ resolved_devices }}"
              sequence:
                - service: "{{ repeat.item | trim }}"
                  data:
                    title: "ðŸ§Š Reminder"
                    message: "{{ text }}"
                    data:
                      tag: "reminder-{{ id }}"
                      actions: "{{ notification_actions }}"

    default:
      - service: system_log.write
        data:
          level: warning
          message: "My Nudgr: Unknown priority '{{ priority }}' for reminder '{{ text }}'."
